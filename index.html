<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow">
  <title>Check-in Instructions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100vw;
    }

    .popup-scroll {
      max-height: 380px;
      overflow-y: auto;
    }

    .icon-marker {
      background: none;
      border: none;
    }

    .icon-wrapper {
      width: 25px;
      height: 25px;
      background: white;
      border: 3px solid #020202;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .icon-wrapper img {
      width: 18px;
      height: 18px;
      object-fit: contain;
    }

    .instruction-bar {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 20px);
      max-width: 520px;
      background: white;
      z-index: 1000;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-btn {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 18px;
      cursor: pointer;
    }

    .nav-btn:disabled {
      background: #cbd5f5;
    }

    .step-text {
      flex: 1;
      font-size: 14px;
    }

    .step-text strong {
      display: block;
      font-size: 15px;
    }
  </style>
</head>

<body>

<div class="instruction-bar">
  <button class="nav-btn" id="prevBtn" onclick="prevStep()">‹</button>
  <div class="step-text" id="stepText"></div>
  <button class="nav-btn" id="nextBtn" onclick="nextStep()">›</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map('map',{ zoomControl:false }).setView([-33.8768, 151.2054], 17);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  subdomains: 'abcd',
  maxZoom: 20
}).addTo(map);

L.control.zoom({ position: 'bottomright' }).addTo(map);

// MARKERS
const sunTower = L.marker([-33.87729669864325, 151.2058196775788])
  .bindPopup(`<strong>Sun Tower Entrance</strong><br>
    <img src="Sun Tower.png" style="width:300px;border-radius:8px;margin-top:8px;">`)
  .addTo(map);

const lockboxIcon = L.divIcon({
  className: 'icon-marker',
  html: `<div class="icon-wrapper"><img src="lockbox.png"></div>`,
  iconAnchor: [10, 17],
});

const lockbox = L.marker(
  [-33.87703364976371, 151.20497041045243],
  { icon: lockboxIcon }
).bindPopup(`
  <div class="popup-scroll">
    <strong>Lockbox – Located on Eagar Street</strong><br>
    <img src="eagar.gif" style="width:300px;border-radius:8px;margin-top:8px;">
  </div>
`, {
  maxHeight: 300,
  minWidth: 330
}).addTo(map);

const apartmentIcon = L.divIcon({
  className: 'icon-marker',
  html: `<div class="icon-wrapper"><img src="apartment.png"></div>`,
  iconAnchor: [10, 17],
});

const property = L.marker(
  [-33.87682707734486, 151.2060015701829],
  { icon: apartmentIcon }
).bindPopup(`
  <strong>Four Haus Residence</strong><br>
  <img src="apartmentImage.png" style="width:300px;border-radius:8px;margin-top:8px;">
`).addTo(map);

// POPUP ONLY (NO MARKER)
const corridorPopup = L.popup({ maxHeight: 300, minWidth:330 })
  .setContent(`
  <div class="popup-scroll">
    <strong>Mall Corridor</strong><br>
    Walk through the mall corridor<br>
    <img src="corridor.gif" style="width:300px;border-radius:8px;margin-top:8px;">
  </div>
`);

// ROUTES
const route0 = L.polyline([
  [-33.87729669864325, 151.2058196775788],
  [-33.87717127441062, 151.205361210565]
], { color:'#0ea5e9', weight:5 });

const route1 = L.polyline([
  [-33.87729669864325, 151.2058196775788],
  [-33.87703364976371, 151.20497041045243]
], { color:'#2563eb', weight:5 });

const route2 = L.polyline([
  [-33.87703364976371, 151.20497041045243],
  [-33.87729669864325, 151.2058196775788]
], { color:'#9333ea', weight:5 });

const route3 = L.polyline([
  [-33.87729669864325, 151.2058196775788],
  [-33.87682707734486, 151.2060015701829]
], { color:'#16a34a', weight:5 });

// Track active route to prevent flash
let activeRoute = null;

// STEPS
const steps = [
  {
    title: "Step 1 – Approach Sun Tower",
    text: "Walk through the mall towards the back.",
    action: () => {
      updateRoute(route0);
      openPopupLower(sunTower);
    }
  },
  {
    title: "Step 2 – Walk through the mall corridor",
    text: "Continue walking through the mall corridor.",
    action: () => {
      updateRoute(route0);
      corridorPopup
        .setLatLng([-33.87717127441062, 151.205361210565])
        .openOn(map);
    }
  },
  {
    title: "Step 3 – Collect keys",
    text: "1) Find lockbox labelled 4H on Eagar Street. <br> 2) Unlock the lockbox with the code provided in your message.<br> 3) Remove everything in the lockbox",
    action: () => {
      updateRoute(route1);
      openPopupLower(lockbox);
    }
  },
  {
    title: "Step 4 – Return to George Street",
    text: "Walk back the same way you came from.",
    action: () => {
      updateRoute(route2);
      lockbox.getPopup().setContent(`
      <div class="popup-scroll">
        <strong>Lockbox – Located on Eagar Street</strong><br>
        <img src="backToGeorge.png" style="width:300px;border-radius:8px;margin-top:8px;">
      </div>
    `);
    }
  },
  {
    title: "Step 5 – Welcome to apartment",
    text: "Walk to The apartment address specified in your message",
    action: () => {
      updateRoute(route3);
      openPopupLower(property);
    }
  }
];

// Function to smoothly switch route without flash
function updateRoute(route) {
  if (activeRoute && map.hasLayer(activeRoute)) {
    map.removeLayer(activeRoute);
  }
  activeRoute = route;
  activeRoute.addTo(map);
}

// Fly to marker and open popup
function openPopupLower(marker, zoom = 18, offsetY = 120) {
  const point = map.latLngToContainerPoint(marker.getLatLng());
  const newPoint = L.point(point.x, point.y - offsetY);
  map.flyTo(map.containerPointToLatLng(newPoint), zoom);
  marker.openPopup();
}

// Navigation buttons
let currentStep = 0;

function renderStep() {
  const step = steps[currentStep];
  step.action();
  document.getElementById("stepText").innerHTML =
    `<strong>${step.title}</strong>${step.text}`;
  prevBtn.disabled = currentStep === 0;
  nextBtn.disabled = currentStep === steps.length - 1;
}

function nextStep(){ if(currentStep < steps.length-1){ currentStep++; renderStep(); }}
function prevStep(){ if(currentStep > 0){ currentStep--; renderStep(); }}

renderStep();
</script>

</body>
</html>
